<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SG Markdown Editor for R2 Storage</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
* { margin: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.container {
    width: 95%;
    padding: 10px;
    background: ghostwhite;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}
/* Header */
.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header h1 { font-size: 24px; font-weight: 600; }

.logout-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.logout-btn:hover { background: rgba(255,255,255,0.3); }

/* Login */
.login-container {
    max-width: 400px;
    width: 100%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    padding: 40px;
}

.login-container h1 { text-align: center; margin-bottom: 30px; color: #333; }

.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
.form-group input {
    width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;
    transition: border-color 0.2s;
}
.form-group input:focus { outline: none; border-color: #667eea; }

.login-btn {
    width: 100%; padding: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; border: none; border-radius: 6px;
    font-size: 16px; font-weight: 600; cursor: pointer;
    transition: transform 0.2s;
}
.login-btn:hover { transform: translateY(-2px); }

/* Messages */
.error { background: #ffebee; color: #c62828; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #c62828; }
.success { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #2e7d32; }

/* Main content */
.main-content { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 100px); max-height: 800px; }
.sidebar { background: #f8f9fa; border-right: 1px solid #e0e0e0; overflow-y: auto; }
.sidebar-header { padding: 20px; border-bottom: 1px solid #e0e0e0; }
.new-file-btn {
    width: 100%; padding: 10px; background: #667eea; color: white;
    border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;
    transition: background 0.2s;
}
.new-file-btn:hover { background: #5568d3; }

.file-list { list-style: none; }
.file-item {
    padding: 12px 20px; border-bottom: 1px solid #e0e0e0;
    cursor: pointer; transition: background 0.2s;
    display: flex; justify-content: space-between; align-items: center;
}
.file-item:hover { background: #e8eaf6; }
.file-item.active { background: #e8eaf6; border-left: 3px solid #667eea; }
.file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; }
.delete-btn {
    background: #ff5252; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;
    font-size: 12px; opacity: 0; transition: opacity 0.2s;
}
.file-item:hover .delete-btn { opacity: 1; }

/* Editor */
.editor-container { padding: 20px; overflow-y: auto; }
.editor-header { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
.editor-header input { flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; }
.save-btn {
    padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer;
    font-size: 14px; font-weight: 500; transition: background 0.2s;
}
.save-btn:hover { background: #45a049; }
.editor-wrapper { border: 2px solid #e0e0e0; border-radius: 6px; overflow: hidden; }
.CodeMirror { height: 500px; font-size: 14px; }
.editor-preview-side, .editor-preview { padding: 10px !important; box-sizing: border-box !important; }
.editor-preview-side { border-left: 1px solid #e0e0e0 !important; }

.empty-state { text-align: center; padding: 60px 20px; color: #999; }
.empty-state h2 { margin-bottom: 10px; color: #666; }

.hidden { display: none; }
.loading { text-align: center; padding: 20px; color: #666; }

</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-container">
    <h1>üîê Login</h1>

    <div id="loginError" class="error hidden"></div>

    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" placeholder="Enter your username">
    </div>

    <div class="form-group">
      <label for="apiKey">Token</label>
      <input type="password" id="apiKey" placeholder="Enter your token">
    </div>

    <button class="login-btn" onclick="login()">Login</button>
</div>

<!-- Main Application -->
<div id="app" class="container hidden">
    <div class="header">
        <h1>üìùSG Markdown Editor</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="userDisplay" style="color: rgba(255,255,255,0.9); font-size: 14px;"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-file-btn" onclick="createNewFile()">+ New File</button>
            </div>
            <div id="fileListContainer"><div class="loading">Loading files...</div></div>
        </div>

        <div class="editor-container">
            <div id="messageContainer"></div>

            <div id="editorContent" class="hidden">
                <div class="editor-header">
                    <input type="text" id="fileName" placeholder="filename.md">
                    <button class="save-btn" onclick="saveFile()">üíæ Save</button>
                </div>
                <div class="editor-wrapper">
                    <textarea id="editor"></textarea>
                </div>
            </div>

            <div id="emptyState" class="empty-state">
                <h2>No file selected</h2>
                <p>Create a new file or select one from the sidebar</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
let currentFile = null;
let editor = null;
const API_BASE = '/api';
let firstClickHintShown = false;

function initEditor() {
  if (!editor) {
    editor = new EasyMDE({
      element: document.getElementById('editor'),
      spellChecker: false,
      autosave: { enabled: true, uniqueId: 'markdown-editor', delay: 1000 },
      placeholder: "Start writing your markdown here...",
      toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen", "|", "guide"],
    });
  }
}

function showLoginError(message) {
  const errorEl = document.getElementById('loginError');
  errorEl.textContent = message;
  errorEl.classList.remove('hidden');
}

async function login() {
  const username = document.getElementById('username').value.trim();
  const token = document.getElementById('apiKey').value.trim();

  if (!username || !token) return showLoginError('Please enter username and token');

  try {
    const response = await fetch(`${API_BASE}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, token }),
      credentials: 'include'
    });

    if (response.ok) {
      const userData = await response.json();
      document.getElementById('userDisplay').textContent = `Welcome, ${userData.name}!`;
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      initEditor();
      await loadFiles();
    } else {
      const err = await response.json();
      showLoginError(err.error || 'Invalid token');
    }
  } catch {
    showLoginError('Connection error. Please try again.');
  }
}

async function logout() {
  try { await fetch(`${API_BASE}/logout`, { method: 'POST', credentials: 'include' }); } catch (_) {}
  document.getElementById('app').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('apiKey').value = '';
  currentFile = null;
}

async function loadFiles() {
  try {
    const response = await fetch(`${API_BASE}/files`, { credentials: 'include' });
    if (response.ok) displayFiles((await response.json()).files);
    else showMessage('Failed to load files', 'error');
  } catch {
    showMessage('Error loading files', 'error');
  }
}

function displayFiles(files) {
  const container = document.getElementById('fileListContainer');
  files = files.filter(f => f.name && f.name.trim().length > 0);

  if (!files.length) return container.innerHTML = '<div class="loading">No files yet. Create one!</div>';

  const fileList = document.createElement('ul');
  fileList.className = 'file-list';

  files.forEach((file, index) => {
    const li = document.createElement('li');
    li.className = 'file-item';
    if (currentFile === file.name) li.classList.add('active');

    const span = document.createElement('span');
    span.className = 'file-name';
    span.textContent = file.name;

    if (!firstClickHintShown && index === 0) {
      const hint = document.createElement('span');
      hint.style.fontSize = '12px';
      hint.style.color = '#667eea';
      hint.style.marginLeft = '6px';
      hint.textContent = '(Click to load)';
      span.appendChild(hint);
    }

    span.onclick = () => { firstClickHintShown = true; openFile(file.name); };

    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = 'üóëÔ∏è';
    delBtn.onclick = (e) => deleteFile(file.name, e);

    li.appendChild(span);
    li.appendChild(delBtn);
    fileList.appendChild(li);
  });

  container.innerHTML = '';
  container.appendChild(fileList);
}

async function openFile(filename) {
  try {
    const response = await fetch(`${API_BASE}/files/${encodeURIComponent(filename)}`, { credentials: 'include' });
    if (response.ok) {
      const content = await response.text();
      currentFile = filename;
      document.getElementById('fileName').value = filename;
      editor.value(content);
      document.getElementById('editorContent').classList.remove('hidden');
      document.getElementById('emptyState').classList.add('hidden');
      updateActiveFileInSidebar();
    } else showMessage('Failed to load file', 'error');
  } catch { showMessage('Error loading file', 'error'); }
}

function updateActiveFileInSidebar() {
  document.querySelectorAll('.file-item').forEach(li => {
    li.classList.remove('active');
    if (li.querySelector('.file-name').textContent === currentFile) li.classList.add('active');
  });
}

function createNewFile() {
  currentFile = null;
  document.getElementById('fileName').value = '';
  editor.value('');
  document.getElementById('editorContent').classList.remove('hidden');
  document.getElementById('emptyState').classList.add('hidden');
  updateActiveFileInSidebar();
}

async function saveFile() {
  const filename = document.getElementById('fileName').value.trim();
  if (!filename) return showMessage('Please enter a filename', 'error');
  if (!filename.endsWith('.md')) return showMessage('Filename must end with .md', 'error');

  const content = editor.value();
  const blob = new Blob([content], { type: 'text/markdown' });
  const formData = new FormData();
  formData.append('file', blob, filename);

  try {
    const url = currentFile === filename ? `${API_BASE}/files/${encodeURIComponent(filename)}` : `${API_BASE}/files`;
    const method = currentFile === filename ? 'PUT' : 'POST';

    const response = await fetch(url, { method, credentials: 'include', body: formData });
    if (response.ok) {
      currentFile = filename;
      showMessage('File saved successfully!', 'success');
      await loadFiles();
      updateActiveFileInSidebar();
    } else showMessage('Failed to save file', 'error');
  } catch { showMessage('Error saving file', 'error'); }
}

async function deleteFile(filename, event) {
  event.stopPropagation();
  if (!confirm(`Are you sure you want to delete "${filename}"?`)) return;
  try {
    const response = await fetch(`${API_BASE}/files/${encodeURIComponent(filename)}`, { method: 'DELETE', credentials: 'include' });
    if (response.ok) {
      showMessage('File deleted successfully!', 'success');
      if (currentFile === filename) {
        currentFile = null;
        document.getElementById('editorContent').classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
      }
      await loadFiles();
    } else showMessage('Failed to delete file', 'error');
  } catch { showMessage('Error deleting file', 'error'); }
}

function showMessage(message, type) {
  const container = document.getElementById('messageContainer');
  const div = document.createElement('div');
  div.className = type;
  div.textContent = message;
  container.innerHTML = '';
  container.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

window.addEventListener('DOMContentLoaded', async () => {
  try {
    const response = await fetch(`${API_BASE}/whoami`, { credentials: 'include' });
    if (response.ok) {
      const userData = await response.json();
      document.getElementById('userDisplay').textContent = `Welcome, ${userData.name}!`;
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      initEditor();
      await loadFiles();
    }
  } catch {}
});
</script>

</body>
</html>
